<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Iniciar Sesión | DomiTulua 🍴</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- CSS foodie -->
    <link rel="stylesheet" href="/frontend/foodie.css" />
    <!-- CSS específico para login -->
    <link rel="stylesheet" href="/frontend/login.css" />
  </head>

  <body class="login-body">
    <!-- Navbar simplificado -->
    <nav class="navbar navbar-expand-lg navbar-login">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="/">
          <i class="bi bi-truck me-2"></i>
          <span>DomiTulua</span>
        </a>
        <a href="/" class="btn-back">
          <i class="bi bi-arrow-left me-2"></i>Volver al inicio
        </a>
      </div>
    </nav>

    <!-- Contenedor principal -->
    <div class="login-container">
      <div class="container">
        <div class="row justify-content-center align-items-center min-vh-100">
          <div class="col-lg-10 col-xl-9">
            <div class="login-card">
              <!-- Lado izquierdo - Información -->
              <div class="login-info">
                <div class="info-content">
                  <h2>¡Bienvenido de vuelta!</h2>
                  <p>
                    Accede a tu cuenta y disfruta de la mejor comida de Tuluá
                  </p>

                  <div class="features">
                    <div class="feature-item">
                      <i class="bi bi-lightning-charge"></i>
                      <span>Pedidos súper rápidos</span>
                    </div>
                    <div class="feature-item">
                      <i class="bi bi-shield-check"></i>
                      <span>Pagos seguros</span>
                    </div>
                    <div class="feature-item">
                      <i class="bi bi-star"></i>
                      <span>Más de 200 restaurantes</span>
                    </div>
                    <div class="feature-item">
                      <i class="bi bi-truck"></i>
                      <span>Delivery hasta tu puerta</span>
                    </div>
                  </div>

                  <div class="testimonial">
                    <div class="testimonial-content">
                      <i class="bi bi-quote"></i>
                      <p>
                        "La mejor app de delivery de Tuluá. Rápida, confiable y
                        con excelente variedad."
                      </p>
                      <div class="testimonial-author">
                        <strong>María González</strong>
                        <div class="rating">
                          <i class="bi bi-star-fill"></i>
                          <i class="bi bi-star-fill"></i>
                          <i class="bi bi-star-fill"></i>
                          <i class="bi bi-star-fill"></i>
                          <i class="bi bi-star-fill"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Lado derecho - Formularios -->
              <div class="login-form-container">
                <!-- Formulario de Login -->
                <div class="form-wrapper" id="loginForm">
                  <div class="form-header">
                    <h3>Iniciar Sesión</h3>
                    <p>Ingresa tus credenciales para acceder</p>
                  </div>

                  <form class="login-form" id="loginFormElement">
                    <div class="form-group">
                      <label for="loginEmail">
                        <i class="bi bi-envelope"></i>
                        Correo electrónico
                      </label>
                      <input
                        type="email"
                        id="loginEmail"
                        name="email"
                        class="form-control"
                        placeholder="tu@email.com"
                        required
                      />
                    </div>

                    <div class="form-group">
                      <label for="loginPassword">
                        <i class="bi bi-lock"></i>
                        Contraseña
                      </label>
                      <div class="password-input">
                        <input
                          type="password"
                          id="loginPassword"
                          name="password"
                          class="form-control"
                          placeholder="Tu contraseña"
                          required
                        />
                        <button
                          type="button"
                          class="password-toggle"
                          onclick="togglePassword('loginPassword')"
                        >
                          <i class="bi bi-eye"></i>
                        </button>
                      </div>
                    </div>

                    <div class="form-options">
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="rememberMe"
                        />
                        <label class="form-check-label" for="rememberMe">
                          Recordarme
                        </label>
                      </div>
                      <a href="#" class="forgot-password"
                        >¿Olvidaste tu contraseña?</a
                      >
                    </div>

                    <button type="submit" class="btn-login-submit">
                      <i class="bi bi-box-arrow-in-right me-2"></i>
                      Iniciar Sesión
                    </button>

                    <div class="social-login">
                      <div class="divider">
                        <span>O continúa con</span>
                      </div>

                      <div class="social-buttons">
                        <button type="button" class="btn-social google">
                          <i class="bi bi-google"></i>
                          Google
                        </button>
                        <button type="button" class="btn-social facebook">
                          <i class="bi bi-facebook"></i>
                          Facebook
                        </button>
                      </div>
                    </div>

                    <div class="form-footer">
                      <p>
                        ¿No tienes cuenta?
                        <a href="#" onclick="showRegisterForm()"
                          >Regístrate aquí</a
                        >
                      </p>
                    </div>
                  </form>
                </div>

                <!-- Formulario de Registro -->
                <div class="form-wrapper hidden" id="registerForm">
                  <div class="form-header">
                    <h3>Crear Cuenta</h3>
                    <p>Únete a la familia DomiTulua</p>
                  </div>

                  <form class="login-form" id="registerFormElement">
                    <div class="form-group">
                      <label for="username">
                        <i class="bi bi-person"></i>
                        Nombre completo
                      </label>
                      <input
                        type="text"
                        id="username"
                        name="username"
                        class="form-control"
                        placeholder="Tu nombre completo"
                        required
                      />
                    </div>

                    <div class="form-group">
                      <label for="registerEmail">
                        <i class="bi bi-envelope"></i>
                        Correo electrónico
                      </label>
                      <input
                        type="email"
                        id="registerEmail"
                        name="email"
                        class="form-control"
                        placeholder="tu@email.com"
                        required
                      />
                    </div>

                    <div class="form-group">
                      <label for="registerPassword">
                        <i class="bi bi-lock"></i>
                        Contraseña
                      </label>
                      <div class="password-input">
                        <input
                          type="password"
                          id="registerPassword"
                          name="password"
                          class="form-control"
                          placeholder="Mínimo 6 caracteres"
                          required
                        />
                        <button
                          type="button"
                          class="password-toggle"
                          onclick="togglePassword('registerPassword')"
                        >
                          <i class="bi bi-eye"></i>
                        </button>
                      </div>
                    </div>

                    <div class="form-group">
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="acceptTerms"
                          required
                        />
                        <label class="form-check-label" for="acceptTerms">
                          Acepto los <a href="#">términos y condiciones</a> y la
                          <a href="#">política de privacidad</a>
                        </label>
                      </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-form">
                      <i class="bi bi-person-plus"></i>
                      Crear cuenta
                    </button>

                    <div class="form-footer">
                      <p>
                        ¿Ya tienes cuenta?
                        <a href="#" onclick="showLoginForm()"
                          >Inicia sesión aquí</a
                        >
                      </p>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Alternar entre formularios
      function showRegisterForm() {
        document.getElementById("loginForm").classList.add("hidden");
        document.getElementById("registerForm").classList.remove("hidden");
      }

      function showLoginForm() {
        document.getElementById("registerForm").classList.add("hidden");
        document.getElementById("loginForm").classList.remove("hidden");
      }

      // Alternar visibilidad de contraseña
      function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const button = input.parentElement.querySelector(".password-toggle i");

        if (input.type === "password") {
          input.type = "text";
          button.className = "bi bi-eye-slash";
        } else {
          input.type = "password";
          button.className = "bi bi-eye";
        }
      }

      // Validación de fortaleza de contraseña (simplificada)
      document
        .getElementById("registerPassword")
        .addEventListener("input", function () {
          const password = this.value;
          if (password.length < 6) {
            this.setCustomValidity(
              "La contraseña debe tener al menos 6 caracteres"
            );
          } else {
            this.setCustomValidity("");
          }
        });

      // Manejar envío de formularios
      document
        .getElementById("loginFormElement")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = {
            email: document.getElementById("loginEmail").value,
            password: document.getElementById("loginPassword").value,
          };

          try {
            const response = await fetch("/api/v1/users/login", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formData),
            });

            const result = await response.json();

            if (result.ok) {
              // Guardar token y datos del usuario
              localStorage.setItem("token", result.token);
              localStorage.setItem("user", JSON.stringify(result.user));

              // Redireccionar según el rol
              if (result.user.role === "admin") {
                window.location.href = "/public/admin-dashboard.html";
              } else {
                window.location.href = "/public/user-dashboard.html";
              }
            } else {
              alert("Error: " + result.msg);
            }
          } catch (error) {
            alert("Error de conexión");
          }
        });

      document
        .getElementById("registerFormElement")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = {
            username: document.getElementById("username").value,
            email: document.getElementById("registerEmail").value,
            password: document.getElementById("registerPassword").value,
          };

          try {
            const response = await fetch("/api/v1/users/register", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formData),
            });

            const result = await response.json();

            if (result.ok) {
              alert("¡Registro exitoso!");
              showLoginForm();
            } else {
              alert("Error: " + result.msg);
            }
          } catch (error) {
            alert("Error de conexión");
          }
        });
    </script>
  </body>
</html>
