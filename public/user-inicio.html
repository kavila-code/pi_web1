<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inicio - DomiTulua</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/frontend/foodie.css" />
    <link rel="stylesheet" href="/frontend/user-inicio.css" />
    <style>
      /* Estilos para el bot√≥n 'Mis Pedidos' en el navbar */
      .custom-orders-link .header-icon {
        background: rgba(255,255,255,0.12);
        color: #fff;
      }

      .custom-orders-link .header-icon.small-icon {
        background: rgba(255,255,255,0.12);
        color: #fff;
      }
    </style>
  </head>

  <body class="user-inicio-body">
    <!-- Top Navigation -->
    <nav class="navbar navbar-expand-lg navbar-custom">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="/public/user-inicio.html">
          <i class="bi bi-truck me-2"></i>
          <span>DomiTulua</span>
        </a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <!-- Links de navegaci√≥n alineados a la izquierda (misma estructura que en index.html) -->
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link active" href="/public/user-inicio.html">
                <i class="bi bi-house me-1"></i>Inicio
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#restaurantes">Restaurantes</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#ofertas">Ofertas</a>
            </li>
            <li class="nav-item" id="myRestaurantsNavItem2" style="display:none;">
              <a class="nav-link" href="/public/my-restaurants.html">
                <i class="bi bi-shop me-1"></i>Mis Restaurantes
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link d-flex align-items-center custom-orders-link" href="/public/user-dashboard.html#orders">
                <span class="me-2">Mis Pedidos</span>
                <span class="header-icon small-icon" aria-hidden="true"><i class="bi bi-bag"></i></span>
              </a>
            </li>
          </ul>

          <!-- Acciones del navbar alineadas a la derecha: usar misma estructura y clases que en index.html -->
          <div class="navbar-actions d-flex align-items-center">
            <!-- User dropdown first -->
            <div class="nav-item dropdown ms-2">
              <a
                class="btn btn-login dropdown-toggle d-flex align-items-center"
                href="#"
                id="userMenuBtn"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <i class="bi bi-person-circle me-1" aria-hidden="true"></i>
                <span id="userGreeting">Mi Cuenta</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenuBtn">
                <li>
                  <a class="dropdown-item" href="/public/user-dashboard.html">
                    <i class="bi bi-speedometer2"></i> Mi Dashboard
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="#mis-pedidos">
                    <i class="bi bi-bag"></i> Mis Pedidos
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="#favoritos">
                    <i class="bi bi-heart"></i> Favoritos
                  </a>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="#" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> Cerrar Sesi√≥n
                  </a>
                </li>
              </ul>
            </div>

            <!-- Cart button positioned to the right of Mi Cuenta -->
            <div class="ms-3 position-relative">
              <button id="cartButton" class="btn-cart" aria-label="Carrito">
                <i class="bi bi-cart3"></i>
                <span class="cart-count" id="cartCount">0</span>
              </button>
              <!-- Cart preview (hidden; toggled by JS) -->
              <div id="cartPreview" class="cart-preview shadow-sm bg-white rounded" style="display:none;">
                <div class="p-3">
                  <h6 class="mb-2">Tu carrito</h6>
                  <div id="cartItemsContainer">
                    <p class="text-muted">Tu carrito est√° vac√≠o.</p>
                  </div>
                  <div class="mt-3 d-flex justify-content-between align-items-center">
                    <strong id="cartTotal">Total: $0</strong>
                    <div>
                      <a href="/public/checkout.html" id="gotoCheckout" class="btn btn-primary btn-sm">Ir a pagar</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Welcome Hero Section (unificado con homepage) -->
    <section class="hero-section">
      <div class="container">
        <h1>
          <span id="personalGreeting">¬°Hola!</span>
          <span class="highlight">¬øQu√© te apetece hoy?</span>
        </h1>
        <p>Descubre los mejores restaurantes y disfruta de tus platillos favoritos</p>

        <!-- Buscador Principal -->
        <div class="search-container">
          <div class="search-box">
            <i class="bi bi-search search-icon"></i>
            <input
              type="text"
              class="search-input"
              placeholder="¬øQu√© quieres pedir hoy? Pizza, hamburguesa, sushi..."
              id="mainSearch"
            />
            <button class="search-btn" aria-label="Buscar">
              <i class="bi bi-arrow-right"></i>
            </button>
          </div>

          <!-- Sugerencias r√°pidas -->
          <div class="quick-suggestions">
            <span class="suggestion-label">Popular:</span>
            <button class="suggestion-tag">üçï Pizza</button>
            <button class="suggestion-tag">üçî Hamburguesa</button>
            <button class="suggestion-tag">üç£ Sushi</button>
            <button class="suggestion-tag">üåÆ Tacos</button>
            <button class="suggestion-tag">üçù Pasta</button>
          </div>
        </div>

        <!-- botones principales eliminados en esta vista por requerimiento -->
      </div>
    </section>

    <!-- Restaurantes Afiliados (movido desde homepage) -->
    <section class="restaurants-section" id="restaurantes">
      <div class="container">
        <div class="text-center mb-5">
          <h2>Restaurantes Afiliados</h2>
          <p class="section-subtitle">Descubre los mejores restaurantes de Tulu√°</p>
          <div class="mt-3">
            <a href="#" class="btn btn-register-restaurant" onclick="openRestaurantRegistration(event)">
              <i class="bi bi-shop"></i> ¬øTienes un restaurante? ¬°Reg√≠stralo aqu√≠!
            </a>
          </div>
        </div>
        <div class="row" id="affiliatedRestaurantsStatic">
          <div class="col-lg-4 col-md-6 mb-4">
            <div class="restaurant-card">
              <div class="restaurant-image">
                <img src="/imagenes/restaurantes/LA%20BELLA%20ITALIA.jpg" alt="Restaurante Italiano" />
                <div class="restaurant-rating"><i class="bi bi-star-fill"></i><span>4.8</span></div>
              </div>
              <div class="restaurant-content">
                <h4>La Bella Italia</h4>
                <p class="restaurant-category">Comida Italiana</p>
                <p class="restaurant-description">Aut√©ntica cocina italiana con ingredientes frescos</p>
                <div class="restaurant-info">
                  <span class="delivery-time"><i class="bi bi-clock"></i>30-45 min</span>
                  <span class="delivery-cost"><i class="bi bi-truck"></i>$3.000</span>
                </div>
                <button class="btn-view-restaurant" onclick="location.href='/public/restaurant-menu.html?id=1'">Ver Men√∫</button>
              </div>
            </div>
          </div>
          <div class="col-lg-4 col-md-6 mb-4">
            <div class="restaurant-card">
              <div class="restaurant-image">
                <img src="/imagenes/restaurantes/SAKURA%20SUSHI.jpg" alt="Restaurante Japon√©s" />
                <div class="restaurant-rating"><i class="bi bi-star-fill"></i><span>4.9</span></div>
              </div>
              <div class="restaurant-content">
                <h4>Sakura Sushi</h4>
                <p class="restaurant-category">Comida Japonesa</p>
                <p class="restaurant-description">Los mejores sushi y rolls de la ciudad</p>
                <div class="restaurant-info">
                  <span class="delivery-time"><i class="bi bi-clock"></i>25-40 min</span>
                  <span class="delivery-cost"><i class="bi bi-truck"></i>$2.500</span>
                </div>
                <button class="btn-view-restaurant" onclick="location.href='/public/restaurant-menu.html?id=3'">Ver Men√∫</button>
              </div>
            </div>
          </div>
          <div class="col-lg-4 col-md-6 mb-4">
            <div class="restaurant-card">
              <div class="restaurant-image">
                <img src="/imagenes/restaurantes/burger-master.jpg" alt="Hamburguesas" />
                <div class="restaurant-rating"><i class="bi bi-star-fill"></i><span>4.7</span></div>
              </div>
              <div class="restaurant-content">
                <h4>Burger Master</h4>
                <p class="restaurant-category">Hamburguesas Gourmet</p>
                <p class="restaurant-description">Las hamburguesas m√°s jugosas y sabrosas</p>
                <div class="restaurant-info">
                  <span class="delivery-time"><i class="bi bi-clock"></i>20-35 min</span>
                  <span class="delivery-cost"><i class="bi bi-truck"></i>$3.500</span>
                </div>
                <button class="btn-view-restaurant" onclick="location.href='/public/restaurant-menu.html?id=2'">Ver Men√∫</button>
              </div>
            </div>
          </div>
        </div>
        <div class="text-center mt-5">
          <a href="/public/restaurants.html" class="btn btn-outline-custom">
            <i class="bi bi-building me-2"></i>Ver Todos los Restaurantes
          </a>
        </div>
      </div>
    </section>

    <!-- Quick Stats Section -->
    <section class="quick-stats">
      <div class="container">
        <div class="row">
          <div class="col-md-3 col-6">
            <div class="stat-card">
              <div class="stat-icon">
                <i class="bi bi-bag-check"></i>
              </div>
              <div class="stat-content">
                <h3 id="totalOrders">12</h3>
                <p>Pedidos Realizados</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-6">
            <div class="stat-card">
              <div class="stat-icon">
                <i class="bi bi-heart-fill"></i>
              </div>
              <div class="stat-content">
                <h3 id="favoriteRestaurants">5</h3>
                <p>Restaurantes Favoritos</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-6">
            <div class="stat-card">
              <div class="stat-icon">
                <i class="bi bi-star-fill"></i>
              </div>
              <div class="stat-content">
                <h3 id="loyaltyPoints">350</h3>
                <p>Puntos Acumulados</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-6">
            <div class="stat-card">
              <div class="stat-icon">
                <i class="bi bi-percent"></i>
              </div>
              <div class="stat-content">
                <h3 id="totalSavings">15%</h3>
                <p>Ahorros del Mes</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Recent Orders Section -->
    <section class="recent-orders" id="recent-orders">
      <div class="container">
        <div class="section-header">
          <h2><i class="bi bi-clock-history"></i> Pedidos Recientes</h2>
          <a href="/public/user-dashboard.html" class="btn btn-outline-primary"
            >Ver Todos</a
          >
        </div>

        <div class="row" id="recentOrdersRow">
          <div class="text-center py-5" id="recentOrdersLoading">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3 text-muted">Cargando pedidos...</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Special Offers Section -->
    <section class="special-offers" id="ofertas">
      <div class="container">
        <div class="section-header">
          <h2><i class="bi bi-fire"></i> Ofertas Especiales</h2>
          <span class="badge bg-danger">¬°Limitadas!</span>
        </div>

        <div class="row">
          <div class="col-lg-6 mb-4">
            <div class="offer-card featured">
              <div class="offer-badge">-30%</div>
              <div class="offer-content">
                <div class="offer-info">
                  <h4>Pizza Grande + Gaseosa</h4>
                  <p>En Pizza Palace - Solo hoy</p>
                  <div class="offer-price">
                    <span class="old-price">$35.00</span>
                    <span class="new-price">$24.50</span>
                  </div>
                </div>
                <button class="btn btn-primary">Ordenar Ahora</button>
              </div>
            </div>
          </div>

          <div class="col-lg-6 mb-4">
            <div class="offer-card">
              <div class="offer-badge">-25%</div>
              <div class="offer-content">
                <div class="offer-info">
                  <h4>Combo Familiar</h4>
                  <p>En Burger Express - Weekend</p>
                  <div class="offer-price">
                    <span class="old-price">$45.00</span>
                    <span class="new-price">$33.75</span>
                  </div>
                </div>
                <button class="btn btn-primary">Ordenar Ahora</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Favorite Restaurants Section -->
    <!-- Nuestro Men√∫ (copiado desde homepage) -->
    <section class="menu-section" id="menu">
      <div class="container">
        <div class="text-center mb-5">
          <h2>Nuestro Men√∫</h2>
          <p class="section-subtitle">
            Explora nuestra deliciosa variedad de platos
          </p>
        </div>

        <!-- Filtros de categor√≠as -->
        <div class="menu-filters text-center mb-5">
          <button class="filter-btn active" data-filter="all">
            <i class="bi bi-grid-3x3-gap me-2"></i>Todo
          </button>
          <button class="filter-btn" data-filter="pizza">
            <i class="bi bi-circle me-2"></i>Pizza
          </button>
          <button class="filter-btn" data-filter="burger">
            <i class="bi bi-list me-2"></i>Hamburguesas
          </button>
          <button class="filter-btn" data-filter="sushi">
            <i class="bi bi-star me-2"></i>Sushi
          </button>
          <button class="filter-btn" data-filter="dessert">
            <i class="bi bi-heart me-2"></i>Postres
          </button>
          <button class="filter-btn" data-filter="drink">
            <i class="bi bi-cup-straw me-2"></i>Bebidas
          </button>
        </div>

        <!-- Grid de productos (cargado din√°micamente desde la base de datos) -->
        <div class="row menu-grid">
          <!-- Los productos se cargar√°n autom√°ticamente desde /api/v1/products/featured -->
          <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando productos...</span>
            </div>
            <p class="mt-3 text-muted">Cargando men√∫ destacado...</p>
          </div>
        </div>

        <div class="text-center mt-5">
          <a href="#restaurantes" class="btn btn-primary-custom" title="Ver el listado completo de restaurantes">
            <i class="bi bi-eye me-2"></i>Ver Men√∫ Completo
          </a>
        </div>
      </div>
    </section>
    <section class="favorite-restaurants" id="favoritos">
      <div class="container">
        <div class="section-header">
          <h2><i class="bi bi-heart-fill"></i> Tus Restaurantes Favoritos</h2>
          <a href="/public/restaurants.html" class="btn btn-outline-primary">Explorar M√°s</a>
        </div>

        <div class="row" id="favoritesGrid">
          <!-- Los favoritos se cargar√°n din√°micamente aqu√≠ -->
        </div>
      </div>
    </section>

    <!-- All Restaurants Section -->
    <section class="all-restaurants" id="restaurantes">
      <div class="container">
        <div class="section-header">
          <h2><i class="bi bi-shop"></i> Todos los Restaurantes</h2>
          <div class="filter-controls">
            <select class="form-select" id="sortRestaurants">
              <option value="rating">Mejor Calificados</option>
              <option value="delivery-time">Tiempo de Entrega</option>
              <option value="price-low">Precio: Menor a Mayor</option>
              <option value="price-high">Precio: Mayor a Menor</option>
            </select>
          </div>
        </div>

        <div class="row" id="restaurantsList">
          <!-- Los restaurantes se cargar√°n din√°micamente aqu√≠ -->
        </div>

        <div class="text-center mt-4">
          <button class="btn btn-outline-primary" id="loadMoreRestaurants" title="Click: cargar m√°s. Shift+Click: ver previsualizaci√≥n de todos">
            Cargar M√°s Restaurantes
          </button>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <div class="row">
          <div class="col-md-12">
            <div class="footer-brand">
              <h5>DomiTulua</h5>
              <p>Tu comida favorita, entregada con amor</p>
            </div>
          </div>
        </div>
        <hr />
        <div class="text-center">
          <p>&copy; 2025 DomiTulua. Todos los derechos reservados.</p>
        </div>
      </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Common JS (shared utilities and load-more for restaurants) -->
  <script src="/frontend/js/common.js"></script>
  <script src="/frontend/js/cart.js"></script>
  <script src="/frontend/js/favorites.js"></script>
  <script src="/frontend/js/index.js"></script>

    <!-- Custom JavaScript -->
    <script>
      // Variables globales
      let currentUser = null;

      // Verificaci√≥n de autenticaci√≥n
      document.addEventListener("DOMContentLoaded", function () {
        const token = localStorage.getItem("token");
        const user = JSON.parse(localStorage.getItem("user") || "{}");

        if (!token) {
          window.location.href = "/login";
          return;
        }

        // Verificar si es admin y redirigir
        if (user.role === "admin") {
          window.location.href = "/admin-dashboard";
          return;
        }

      currentUser = user;
  loadUserData(user);
  // Inicializar la lista de restaurantes desde la API y renderizar los primeros
  renderRestaurantsContainer(6, '#restaurantsList').catch(e => {
    console.error('Error cargando restaurantes:', e);
    document.querySelector('#restaurantsList').innerHTML = '<div class="col-12 text-center py-5"><p class="text-danger">Error al cargar restaurantes</p></div>';
  });

  // Inicializar comportamiento de 'Cargar M√°s Restaurantes'
  try { initLoadMoreRestaurants(); } catch (e) { console.warn('initLoadMoreRestaurants no disponible:', e); }

  // Event listeners
  setupEventListeners();

  // Cargar pedidos recientes pagados
  loadRecentOrders();

  // Verificar si el usuario tiene restaurantes
  checkMyRestaurantsNav();
      });

      function loadUserData(user) {
        // Personalizar saludo
        const greeting = document.getElementById("personalGreeting");
        const userMenu = document.getElementById("userGreeting");

        if (user.nombre) {
          greeting.textContent = `¬°Hola ${user.nombre}!`;
          userMenu.textContent = user.nombre;
        }

        // Cargar estad√≠sticas reales del usuario
        loadUserStats();
      }

      async function loadUserStats() {
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
          // Obtener pedidos del usuario
          const ordersRes = await fetch('/api/v1/my-orders', {
            headers: { 'Authorization': `Bearer ${token}` }
          });

          let totalOrders = 0;
          let totalSpent = 0;
          let completedOrders = 0;

          if (ordersRes.ok) {
            const ordersData = await ordersRes.json();
            const orders = ordersData.data || [];
            totalOrders = orders.length;
            
            // Calcular total gastado y pedidos completados
            orders.forEach(order => {
              if (order.total_amount) {
                totalSpent += parseFloat(order.total_amount);
              }
              if (order.status === 'delivered' || order.status === 'completed') {
                completedOrders++;
              }
            });
          }

          // Obtener restaurantes favoritos (simulado por ahora, puedes agregar una tabla de favoritos)
          const favoriteRestaurants = Math.floor(totalOrders / 3); // Estimaci√≥n basada en pedidos

          // Calcular puntos de lealtad (100 puntos por cada pedido completado)
          const loyaltyPoints = completedOrders * 100;

          // Calcular ahorros (estimado en 15% del total gastado en ofertas)
          const totalSavings = totalSpent > 0 ? Math.floor((totalSpent * 0.15) / totalSpent * 100) : 0;

          // Actualizar UI
          document.getElementById("totalOrders").textContent = totalOrders;
          document.getElementById("favoriteRestaurants").textContent = favoriteRestaurants;
          document.getElementById("loyaltyPoints").textContent = loyaltyPoints;
          document.getElementById("totalSavings").textContent = totalSavings + "%";

        } catch (error) {
          console.error('Error cargando estad√≠sticas:', error);
          // Valores por defecto en caso de error
          document.getElementById("totalOrders").textContent = "0";
          document.getElementById("favoriteRestaurants").textContent = "0";
          document.getElementById("loyaltyPoints").textContent = "0";
          document.getElementById("totalSavings").textContent = "0%";
        }
      }

      async function loadRestaurants() {
        try {
          const res = await fetch('/api/v1/restaurants');
          if (!res.ok) throw new Error('No se pudieron cargar restaurantes');
          const json = await res.json();
          const restaurants = json.data || json.restaurants || [];

          const restaurantsList = document.getElementById("restaurantsList");
          restaurantsList.innerHTML = "";

          if (!restaurants.length) {
            restaurantsList.innerHTML = '<div class="col-12 text-center"><p class="text-muted">No hay restaurantes disponibles</p></div>';
            return;
          }

          restaurants.forEach((restaurant) => {
            const restaurantCard = createRestaurantCard(restaurant);
            restaurantsList.appendChild(restaurantCard);
          });
        } catch (err) {
          console.error('Error cargando restaurantes:', err);
          const restaurantsList = document.getElementById("restaurantsList");
          restaurantsList.innerHTML = '<div class="col-12 text-center"><p class="text-danger">Error al cargar restaurantes</p></div>';
        }
      }

      function createRestaurantCard(restaurant) {
        const col = document.createElement("div");
        col.className = "col-lg-4 col-md-6 mb-4";

        const logo = restaurant.logo_url || restaurant.image || '/frontend/placeholder-restaurant.svg';
        const rating = (restaurant.avg_rating || restaurant.rating || 0).toFixed(1);
        const reviews = restaurant.total_reviews || restaurant.reviews || 0;
        const deliveryTime = restaurant.delivery_time || restaurant.deliveryTime || `${restaurant.delivery_time_min || 30}-${restaurant.delivery_time_max || 45} min`;
        const deliveryFee = restaurant.delivery_cost != null ? `$${Number(restaurant.delivery_cost).toLocaleString()}` : (restaurant.deliveryFee || 'Gratis');

        col.innerHTML = `
          <div class="restaurant-card" onclick="location.href='/public/restaurant-menu.html?id=${restaurant.id}'" style="cursor:pointer">
            <div class="restaurant-image">
              <img src="${logo}" alt="${restaurant.name}" onerror="this.onerror=null;this.src='/frontend/placeholder-restaurant.svg'">
              <div class="favorite-toggle" onclick="event.stopPropagation();toggleFavorite(${restaurant.id})">
                <i class="bi bi-heart"></i>
              </div>
            </div>
            <div class="restaurant-info">
              <h5>${restaurant.name}</h5>
              <div class="restaurant-rating">
                <i class="bi bi-star-fill"></i>
                <span>${rating}</span>
                <small>(${reviews} rese√±as)</small>
              </div>
              <p class="restaurant-category">${restaurant.category || 'General'}</p>
              <div class="restaurant-meta">
                <span class="delivery-time">
                  <i class="bi bi-clock"></i> ${deliveryTime}
                </span>
                <span class="delivery-fee">
                  <i class="bi bi-truck"></i> ${deliveryFee}
                </span>
              </div>
              <button class="btn btn-primary w-100 mt-2" onclick="event.stopPropagation();location.href='/public/restaurant-menu.html?id=${restaurant.id}'">
                Ver Men√∫
              </button>
            </div>
          </div>
        `;

        return col;
      }

      function setupEventListeners() {
        // B√∫squeda (usar input principal de la hero)
        const searchInput = document.getElementById("mainSearch");
        if (searchInput) {
          searchInput.addEventListener("input", handleSearch);
        }

        // Filtros r√°pidos
        const filterButtons = document.querySelectorAll(".filter-btn");
        if (filterButtons && filterButtons.length) {
          filterButtons.forEach((btn) => {
            btn.addEventListener("click", handleFilter);
          });
        }

        // Ordenamiento
        const sortSelect = document.getElementById("sortRestaurants");
        if (sortSelect) {
          sortSelect.addEventListener("change", (e) => {
            const val = e.target.value;
            // Intentar usar la utilidad compartida; si falla, llamar al handler local
            try {
              sortAndRender(val);
            } catch (err) {
              handleSort(e);
            }
          });
        }

        // Inicializar botones de ofertas (Ordenar Ahora)
        // (sin manejadores personalizados)
      }

      function handleSearch(event) {
        const searchTerm = event.target.value.toLowerCase();
        console.log("Buscando:", searchTerm);
        // Implementar l√≥gica de b√∫squeda
      }

      function handleFilter(event) {
        // Remover clase active de todos los botones
        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.classList.remove("active");
        });

        // Agregar clase active al bot√≥n clickeado
        event.target.classList.add("active");

        const filter = event.target.dataset.filter;
        console.log("Filtro aplicado:", filter);
        // Implementar l√≥gica de filtrado
      }

      function handleSort(event) {
        const sortBy = event.target.value;
        console.log("Ordenar por:", sortBy);
        // Implementar l√≥gica de ordenamiento
      }

      // toggleFavorite se maneja desde /frontend/js/favorites.js

      function viewRestaurant(restaurantId) {
        console.log("Ver restaurante:", restaurantId);
        // Redirigir a p√°gina de restaurante
        alert(
          `Funcionalidad en desarrollo - Ver men√∫ del restaurante ${restaurantId}`
        );
      }

      async function loadRecentOrders() {
        const row = document.getElementById('recentOrdersRow');
        const loading = document.getElementById('recentOrdersLoading');
        if (!row) return;

        try {
          const data = await authenticatedFetch('/api/v1/orders/my-orders?status=entregado&limit=3');
          if (!data || !data.ok) throw new Error('Respuesta inv√°lida');

          const orders = data.data || [];
          if (orders.length === 0) {
            row.innerHTML = `
              <div class=\"text-center py-5\">
                <i class=\"bi bi-bag\" style=\"font-size: 3rem; color: #c9c9c9;\"></i>
                <h5 class=\"mt-3\">Sin registros, realiza tu primera compra</h5>
                <p class=\"text-muted\">Tus pedidos aparecer√°n aqu√≠ cuando completes tu primera compra.</p>
                <a href=\"/public/restaurants.html\" class=\"btn btn-primary mt-2\"><i class=\"bi bi-shop\"></i> Ver restaurantes</a>
              </div>`;
            return;
          }

          row.innerHTML = orders.map(o => {
            const statusClass = o.status === 'entregado' ? 'delivered' : '';
            const total = Number(o.total || 0).toLocaleString('es-CO');
            const createdAt = new Date(o.created_at).toLocaleDateString('es-CO', { year:'numeric', month:'short', day:'numeric' });
            const logo = o.restaurant_logo || '/frontend/placeholder-restaurant.svg';
            const restName = o.restaurant_name || 'Restaurante';

            return `
              <div class=\"col-lg-4 col-md-6 mb-4\">
                <div class=\"order-card\">
                  <div class=\"order-header\">
                    <img src=\"${logo}\" alt=\"${restName}\" class=\"restaurant-logo\" onerror=\"this.style.display='none'\"/>
                    <div class=\"order-info\">
                      <h5>${restName}</h5>
                      <small class=\"text-muted\">${createdAt}</small>
                    </div>
                    <span class=\"order-status ${statusClass}\">${o.status}</span>
                  </div>
                  <div class=\"order-details\">
                    <div class=\"order-footer\">
                      <span class=\"order-total\">$${total}</span>
                      <a class=\"btn btn-sm btn-outline-primary\" href=\"/public/my-orders.html\">Ver Pedido</a>
                    </div>
                  </div>
                </div>
              </div>`;
          }).join('');
        } catch (e) {
          console.error(e);
          if (row) row.innerHTML = `
              <div class=\"text-center py-5\">\n                <i class=\"bi bi-bag\" style=\"font-size: 3rem; color: #c9c9c9;\"></i>\n                <h5 class=\"mt-3\">Sin registros, realiza tu primera compra</h5>\n                <p class=\"text-muted\">Tus pedidos aparecer√°n aqu√≠ cuando completes tu primera compra.</p>\n                <a href=\"/public/restaurants.html\" class=\"btn btn-primary mt-2\"><i class=\"bi bi-shop\"></i> Ver restaurantes</a>\n              </div>`;
        } finally {
          if (loading) loading.remove();
        }
      }

      function logout() {
        console.log("Logout function called");
        try {
          if (confirm("¬øEst√°s seguro de que deseas cerrar sesi√≥n?")) {
            localStorage.removeItem("token");
            localStorage.removeItem("user");
            window.location.href = "/login";
          }
        } catch (error) {
          console.error("Error in logout function:", error);
          alert("Error al cerrar sesi√≥n: " + error.message);
        }
      }

      
    </script>

    <!-- Cargar productos destacados din√°micamente desde la base de datos -->
    <script>
      document.addEventListener('DOMContentLoaded', async function() {
        const grid = document.querySelector('.menu-section .menu-grid');
        if (!grid) return;

        try {
          const res = await fetch('/api/v1/products/featured?limit=12');
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const json = await res.json();
          if (!json.ok || !Array.isArray(json.data)) throw new Error('Respuesta inv√°lida');

          const items = json.data;
          
          if (items.length === 0) {
            grid.innerHTML = '<div class="col-12 text-center py-5"><p class="text-muted">No hay productos destacados disponibles en este momento</p></div>';
            return;
          }

          const frag = document.createDocumentFragment();
          grid.innerHTML = '';

          items.forEach(p => {
            const name = p.name || 'Producto';
            const desc = p.description || 'Especialidad del restaurante';
            const price = Number(p.price || 0);
            const img = p.image_url || (window.guessFoodImage && window.guessFoodImage(name)) || '/imagenes/comida/default.jpg';
            const candidates = (window.guessFoodImageCandidates && window.guessFoodImageCandidates(name)) || [];
            const category = (p.category || '').toLowerCase();

            const div = document.createElement('div');
            div.className = 'col-lg-4 col-md-6 mb-4 menu-item';
            if (category) div.setAttribute('data-category', category);
            if (p.id) div.setAttribute('data-product-id', p.id);
            if (p.restaurant_id) div.setAttribute('data-restaurant-id', p.restaurant_id);
            
            div.innerHTML = `
              <div class="menu-card">
                <div class="menu-image">
                  <img src="${img}" alt="${name}" data-candidates='${JSON.stringify(candidates)}' data-idx="0" onerror="window.tryNextFoodImage && window.tryNextFoodImage(this)">
                </div>
                <div class="menu-content">
                  <h4>${name}</h4>
                  <p>${desc}</p>
                  <div class="menu-footer">
                    <span class="price">$${price.toLocaleString('es-CO')}</span>
                    <button class="btn-add-cart" title="Agregar"><i class="bi bi-cart-plus"></i></button>
                  </div>
                </div>
              </div>`;
            frag.appendChild(div);
          });
          
          grid.appendChild(frag);

          // Reinicializar manejadores de eventos para los productos cargados din√°micamente
          if (typeof setupMenuPreviews === 'function') {
            setupMenuPreviews();
          }
          
          console.log(`‚úì Cargados ${items.length} productos destacados desde la base de datos`);
          
        } catch (e) {
          console.error('Error al cargar productos destacados:', e);
          grid.innerHTML = `
            <div class="col-12 text-center py-5">
              <i class="bi bi-exclamation-circle text-danger" style="font-size: 3rem;"></i>
              <p class="mt-3 text-danger fw-bold">Error al cargar productos</p>
              <p class="text-muted">${e.message}</p>
              <a href="/public/restaurants.html" class="btn btn-primary mt-3">Ver Restaurantes</a>
            </div>`;
        }
      });

      // Verificar si el usuario tiene restaurantes para mostrar bot√≥n navbar
      async function checkMyRestaurantsNav() {
        try {
          const token = localStorage.getItem('token');
          if (!token) return;
          const res = await fetch('/api/v1/my-restaurants', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!res.ok) return;
          const json = await res.json();
          const restaurants = json.data || [];
          if (restaurants.length > 0) {
            const navItem = document.getElementById('myRestaurantsNavItem2');
            if (navItem) navItem.style.display = 'block';
          }
        } catch (err) {
          console.error('Error checking restaurants nav:', err);
        }
      }

      // Renderizar favoritos al cargar si est√° el contenedor
      document.addEventListener('DOMContentLoaded', function(){
        if (document.querySelector('#favoritesGrid') && typeof renderFavoriteRestaurants === 'function') {
          renderFavoriteRestaurants('#favoritesGrid');
        }
      });
    </script>
  </body>
</html>
