<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mis Restaurantes - DomiTulua</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/frontend/foodie.css">
  <link rel="stylesheet" href="/frontend/user-inicio.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="/public/user-inicio.html">
        <i class="bi bi-truck me-2"></i>
        <span>DomiTulua</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="/public/user-inicio.html"><i class="bi bi-house me-1"></i>Inicio</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/public/my-restaurants.html"><i class="bi bi-shop me-1"></i>Mis Restaurantes</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/public/user-dashboard.html"><i class="bi bi-person me-1"></i>Mi Cuenta</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="logout()"><i class="bi bi-box-arrow-right me-1"></i>Salir</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container my-5 pt-4">
    <div class="row">
      <div class="col-12">
        <div class="section-header mb-4 d-flex align-items-center justify-content-between">
          <h2 class="mb-0"><i class="bi bi-shop"></i> Mis Restaurantes</h2>
          <a href="/register-restaurant" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Registrar Nuevo Restaurante
          </a>
        </div>

        <!-- Loading -->
        <div id="loadingRestaurants" class="text-center py-5 d-none">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mt-2">Cargando restaurantes...</p>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center d-none">
          <div class="py-5">
            <i class="bi bi-shop" style="font-size: 3rem; color: #c9c9c9;"></i>
            <h5 class="mt-3">Aún no tienes restaurantes</h5>
            <p class="text-muted">Registra tu primer restaurante para empezar a vender.</p>
            <a href="/register-restaurant" class="btn btn-outline-primary"><i class="bi bi-plus-circle"></i> Registrar ahora</a>
          </div>
        </div>

        <!-- Restaurants Grid -->
        <div id="restaurantsGrid" class="row g-4">
          <!-- Se llenará dinámicamente -->
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/frontend/js/common.js"></script>
  <script>
    // Verificar autenticación
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = '/login';
    }

    async function loadMyRestaurants() {
      const loading = document.getElementById('loadingRestaurants');
      const empty = document.getElementById('emptyState');
      const grid = document.getElementById('restaurantsGrid');

      loading.classList.remove('d-none');
      empty.classList.add('d-none');
      grid.innerHTML = '';

      try {
        const res = await fetch('/api/v1/my-restaurants', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) {
          if (res.status === 401) {
            localStorage.removeItem('token');
            window.location.href = '/login';
            return;
          }
          const errorData = await res.json().catch(() => ({}));
          console.error('Error response:', res.status, errorData);
          throw new Error(errorData.message || 'Error al cargar restaurantes');
        }

        const json = await res.json();
        console.log('Restaurantes cargados:', json);
        const restaurants = json.data || [];

        loading.classList.add('d-none');

        if (!restaurants.length) {
          empty.classList.remove('d-none');
          return;
        }

        restaurants.forEach(restaurant => {
          const card = createRestaurantCard(restaurant);
          grid.appendChild(card);
        });
      } catch (err) {
        console.error('Error completo:', err);
        loading.classList.add('d-none');
        alert('Error al cargar restaurantes: ' + err.message);
      }
    }

    function createRestaurantCard(r) {
      const col = document.createElement('div');
      col.className = 'col-md-6 col-lg-4 mb-4';

      const statusBadge = getStatusBadge(r.status);
      const logo = r.logo_url || '/frontend/placeholder-restaurant.svg';
      const rating = Number(r.avg_rating || 0).toFixed(1);
      const products = r.products_count || 0;
      const category = escapeHtml(r.category || 'Sin categoría');
      const address = escapeHtml(r.address || '');
      const statusClass = r.status === 'active' ? 'bg-success' : (r.status === 'pending' ? 'bg-warning text-dark' : (r.status === 'rejected' ? 'bg-danger' : 'bg-secondary'));
      const statusLabel = r.status === 'active' ? 'Activo' : (r.status === 'pending' ? 'Pendiente' : (r.status === 'rejected' ? 'Rechazado' : 'Inactivo'));

      col.innerHTML = `
        <div class="restaurant-card h-100 d-flex flex-column">
          <div class="restaurant-image position-relative">
            <img src="${logo}" alt="${escapeHtml(r.name)}" onerror="this.onerror=null;this.src='/frontend/placeholder-restaurant.svg'">
            <span class="badge ${statusClass} position-absolute" style="top:10px; right:10px;">${statusLabel}</span>
          </div>
          <div class="restaurant-info flex-grow-1">
            <h5 class="mb-4">${escapeHtml(r.name)}</h5>
            <p class="text-muted mb-1">${category}</p>
            <p class="text-muted mb-1">${address}</p>
            <p class="mb-1"><i class="bi bi-star-fill text-warning"></i> ${rating}</p>
            <p class="mb-0"><i class="bi bi-basket-fill"></i> ${products} producto${products !== 1 ? 's' : ''}</p>
          </div>
          <div class="p-3 pt-0">
            ${r.status === 'active' ? `
              <div class="d-grid gap-2">
                <div class="row g-2">
                  <div class="col-6">
                    <a href="/public/edit-restaurant.html?id=${r.id}" class="btn btn-primary w-100">
                      <i class="bi bi-pencil"></i> Editar
                    </a>
                  </div>
                  <div class="col-6">
                    <a href="/public/restaurant-menu.html?id=${r.id}" class="btn btn-outline-secondary w-100" target="_blank">
                      <i class="bi bi-eye"></i> Ver
                    </a>
                  </div>
                </div>
                <a href="/public/edit-restaurant.html?id=${r.id}#tab-products" class="btn btn-outline-success w-100">
                  <i class="bi bi-plus-circle"></i> Agregar Producto
                </a>
              </div>
            ` : ''}
            ${r.status === 'pending' ? `
              <button class="btn btn-warning w-100" disabled>
                <i class="bi bi-hourglass-split"></i> Pendiente de aprobación
              </button>
            ` : ''}
            ${r.status === 'rejected' ? `
              <button class="btn btn-danger w-100" disabled>
                <i class="bi bi-x-circle"></i> Rechazado
              </button>
            ` : ''}
          </div>
        </div>
      `;

      return col;
    }

    function getStatusBadge(status) {
      const badges = {
        'active': '<span class="badge bg-success">Activo</span>',
        'pending': '<span class="badge bg-warning text-dark">Pendiente</span>',
        'rejected': '<span class="badge bg-danger">Rechazado</span>',
        'inactive': '<span class="badge bg-secondary">Inactivo</span>'
      };
      return badges[status] || '';
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function logout() {
      if (confirm('¿Cerrar sesión?')) {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/login';
      }
    }

    // Cargar al iniciar
    document.addEventListener('DOMContentLoaded', loadMyRestaurants);
  </script>
</body>
</html>
