<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel Domiciliario - DomiTulua</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/frontend/foodie.css" />
    <style>
      body {
        background: #f6f8fb;
        font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial, sans-serif;
      }
      .header {
        background: linear-gradient(135deg, #ff6b35, #ff9f43);
        color: #fff;
        padding: 1rem 1.25rem;
      }
      .header h1 {
        font-size: 1.4rem;
        margin: 0;
      }
      .card {
        border: 0;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
        border-radius: 14px;
      }
      .stat {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .stat .badge {
        font-size: 0.8rem;
      }
      .order-item {
        border-bottom: 1px dashed #e9ecef;
        padding: 0.75rem 0;
      }
      .order-item:last-child {
        border-bottom: 0;
      }
    </style>
  </head>
  <body>
    <header class="header d-flex justify-content-between align-items-center">
      <h1><span class="me-2">üö¥‚Äç‚ôÇÔ∏è</span> Panel de Domiciliario</h1>
      <div>
        <button class="btn btn-light btn-sm me-2" onclick="goHome()">
          Inicio
        </button>
        <button class="btn btn-dark btn-sm" onclick="logout()">
          Cerrar sesi√≥n
        </button>
      </div>
    </header>

    <main class="container py-4">
      <div id="guardMessage" class="alert alert-warning d-none"></div>

      <div class="row g-3">
        <div class="col-12 col-lg-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Estado</h5>
              <div class="stat mb-2">
                <span class="badge bg-success" id="roleBadge"
                  >domiciliario</span
                >
                <small class="text-muted" id="userEmail"></small>
              </div>
              <div class="small text-muted">
                √öltimo inicio: <span id="lastLogin">‚Äî</span>
              </div>
            </div>
          </div>
          <div class="card mt-3">
            <div class="card-body">
              <h5 class="card-title">Mi Solicitud</h5>
              <div id="applicationBox" class="small text-muted">Cargando‚Ä¶</div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-8">
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Mis Pedidos</h5>
                <div>
                  <button class="btn btn-outline-primary btn-sm" disabled>
                    Actualizar
                  </button>
                </div>
              </div>
              <div class="mt-3" id="ordersList">
                <div id="assignedOrdersBox" class="mb-3"></div>
                <hr />
                <h6>Pedidos Disponibles</h6>
                <div id="availableOrdersBox"></div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Documentos</h5>
              <div id="docsBox" class="small text-muted">Cargando‚Ä¶</div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Guard de rol: solo domiciliario
      document.addEventListener("DOMContentLoaded", async () => {
        const token = localStorage.getItem("token");
        const userRaw = localStorage.getItem("user");
        const guard = document.getElementById("guardMessage");

        if (!token || !userRaw) {
          window.location.href = "/login";
          return;
        }

        const user = JSON.parse(userRaw);
        document.getElementById("userEmail").textContent = user.email || "";

        if (user.role !== "domiciliario") {
          guard.classList.remove("d-none");
          guard.innerHTML =
            "Acceso restringido: este panel es solo para usuarios con rol <strong>domiciliario</strong>.";
          setTimeout(() => (window.location.href = "/"), 2000);
          return;
        }

        loadMyApplication();
        loadMyDocuments();
        // lastLogin podr√≠a venir desde un endpoint de perfil

        loadAssignedOrders();
        loadAvailableOrders();
      });
      // Cargar pedidos asignados al domiciliario
      async function loadAssignedOrders() {
        const box = document.getElementById("assignedOrdersBox");
        box.innerHTML =
          "<div class='text-muted'>Cargando pedidos asignados‚Ä¶</div>";
        try {
          const res = await fetch("/api/v1/orders/my-deliveries", {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          const data = await res.json();
          if (
            !data.success ||
            !Array.isArray(data.orders) ||
            data.orders.length === 0
          ) {
            box.innerHTML =
              "<div class='text-muted'>No tienes pedidos asignados.</div>";
            return;
          }
          box.innerHTML = data.orders
            .map((order) => renderAssignedOrder(order))
            .join("");
        } catch (e) {
          box.innerHTML =
            "<div class='text-danger'>Error cargando pedidos asignados.</div>";
        }
      }

      // Renderizar un pedido asignado
      function renderAssignedOrder(order) {
        const estados = ["pendiente", "aceptado", "en_camino", "entregado"];
        let nextEstado = "";
        if (order.status === "aceptado") nextEstado = "en_camino";
        if (order.status === "en_camino") nextEstado = "entregado";
        return `
          <div class="order-item">
            <div><strong>#${
              order.order_number
            }</strong> <span class="badge bg-info">${order.status.replace(
          "_",
          " "
        )}</span></div>
            <div><strong>Cliente:</strong> ${order.customer_name || ""}</div>
            <div><strong>Direcci√≥n:</strong> ${order.delivery_address}</div>
            <div><strong>Tel:</strong> ${order.delivery_phone}</div>
            <div><strong>Total:</strong> $${order.total}</div>
            <div class="mt-1">
              ${
                nextEstado
                  ? `<button class="btn btn-sm btn-success" onclick="updateOrderStatus('${
                      order.id
                    }','${nextEstado}')">Marcar como ${nextEstado.replace(
                      "_",
                      " "
                    )}</button>`
                  : ""
              }
            </div>
          </div>
        `;
      }

      // Cargar pedidos disponibles para aceptar
      async function loadAvailableOrders() {
        const box = document.getElementById("availableOrdersBox");
        box.innerHTML =
          "<div class='text-muted'>Cargando pedidos disponibles‚Ä¶</div>";
        try {
          const res = await fetch("/api/v1/orders/available", {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          const data = await res.json();
          if (
            !data.success ||
            !Array.isArray(data.orders) ||
            data.orders.length === 0
          ) {
            box.innerHTML =
              "<div class='text-muted'>No hay pedidos disponibles.</div>";
            return;
          }
          box.innerHTML = data.orders
            .map((order) => renderAvailableOrder(order))
            .join("");
        } catch (e) {
          box.innerHTML =
            "<div class='text-danger'>Error cargando pedidos disponibles.</div>";
        }
      }

      // Renderizar un pedido disponible
      function renderAvailableOrder(order) {
        return `
          <div class="order-item">
            <div><strong>#${
              order.order_number
            }</strong> <span class="badge bg-warning">pendiente</span></div>
            <div><strong>Restaurante:</strong> ${
              order.restaurant_name || ""
            }</div>
            <div><strong>Direcci√≥n:</strong> ${order.delivery_address}</div>
            <div><strong>Total:</strong> $${order.total}</div>
            <div class="mt-1">
              <button class="btn btn-sm btn-primary" onclick="acceptOrder('${
                order.id
              }')">Aceptar pedido</button>
            </div>
          </div>
        `;
      }

      // Aceptar un pedido disponible
      async function acceptOrder(orderId) {
        if (!confirm("¬øAceptar este pedido?")) return;
        try {
          const res = await fetch(`/api/v1/orders/${orderId}/assign`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          const data = await res.json();
          if (data.success) {
            alert("Pedido asignado correctamente.");
            loadAssignedOrders();
            loadAvailableOrders();
          } else {
            alert(data.message || "No se pudo asignar el pedido.");
          }
        } catch (e) {
          alert("Error al asignar el pedido.");
        }
      }

      // Actualizar estado de un pedido asignado
      async function updateOrderStatus(orderId, newStatus) {
        if (!confirm(`¬øMarcar pedido como ${newStatus.replace("_", " ")}?`))
          return;
        try {
          const res = await fetch(`/api/v1/orders/${orderId}/status`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify({ status: newStatus }),
          });
          const data = await res.json();
          if (data.success) {
            alert("Estado actualizado.");
            loadAssignedOrders();
          } else {
            alert(data.message || "No se pudo actualizar el estado.");
          }
        } catch (e) {
          alert("Error al actualizar el estado del pedido.");
        }
      }

      async function loadMyApplication() {
        try {
          const res = await fetch(
            "/api/v1/delivery-applications/my-application",
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          );
          const data = await res.json();
          const box = document.getElementById("applicationBox");
          if (!data.success || !data.data) {
            box.textContent = "No se encontr√≥ tu solicitud.";
            return;
          }
          const app = data.data;
          box.innerHTML = `
          <div><strong>Estado:</strong> <span class="badge ${getStatusBadge(
            app.status
          )}">${app.status}</span></div>
          <div><strong>Fecha solicitud:</strong> ${formatDate(
            app.fecha_solicitud
          )}</div>
          ${
            app.fecha_revision
              ? `<div><strong>Revisi√≥n:</strong> ${formatDate(
                  app.fecha_revision
                )}</div>`
              : ""
          }
          ${
            app.observaciones
              ? `<div><strong>Observaciones:</strong> ${app.observaciones}</div>`
              : ""
          }
        `;
        } catch (e) {
          document.getElementById("applicationBox").textContent =
            "Error cargando tu solicitud.";
        }
      }

      async function loadMyDocuments() {
        try {
          const res = await fetch(
            "/api/v1/delivery-applications/my-application",
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          );
          const { data } = await res.json();
          const box = document.getElementById("docsBox");
          if (!data) {
            box.textContent = "Sin documentos.";
            return;
          }
          const docs = [];
          if (data.cv_file_path)
            docs.push(docLink("Hoja de Vida", data.cv_file_path));
          if (data.id_document_path)
            docs.push(docLink("Documento ID", data.id_document_path));
          if (data.license_photo_path)
            docs.push(docLink("Licencia", data.license_photo_path));
          box.innerHTML = docs.length ? docs.join("") : "Sin documentos.";
        } catch (e) {
          document.getElementById("docsBox").textContent =
            "Error cargando documentos.";
        }
      }

      function docLink(label, path) {
        const url = getDocumentUrl(path);
        return `<div class="mb-1">‚Ä¢ ${label}: <a href="${url}" target="_blank">ver</a></div>`;
      }

      function getDocumentUrl(filePath) {
        if (!filePath) return "";
        if (filePath.startsWith("http")) return filePath;
        const fileName = filePath.split(/[\\\/]/).pop();
        return `/uploads/delivery-applications/${fileName}`;
      }

      function getStatusBadge(status) {
        const map = {
          pendiente: "bg-warning",
          aprobada: "bg-success",
          rechazada: "bg-danger",
        };
        return `badge ${map[status] || "bg-secondary"}`;
      }

      function formatDate(dateStr) {
        if (!dateStr) return "‚Äî";
        const d = new Date(dateStr);
        return d.toLocaleString("es-ES", {
          year: "numeric",
          month: "short",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "/login";
      }

      function goHome() {
        window.location.href = "/";
      }
    </script>
  </body>
</html>
