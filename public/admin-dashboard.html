<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Admin - DomiTulua</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/frontend/foodie.css" />
    <link rel="stylesheet" href="/frontend/admin-dashboard.css" />
  </head>

  <body class="dashboard-body">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h4><i class="bi bi-house-door"></i> DomiTulua</h4>
        <button class="btn-close-sidebar d-lg-none" onclick="toggleSidebar()">
          <i class="bi bi-x"></i>
        </button>
      </div>

      <div class="sidebar-menu">
        <a
          href="#dashboard"
          class="menu-item active"
          onclick="showSection('dashboard')"
        >
          <i class="bi bi-speedometer2"></i>
          <span>Dashboard</span>
        </a>
        <a href="#users" class="menu-item" onclick="showSection('users')">
          <i class="bi bi-people"></i>
          <span>Usuarios</span>
        </a>
        <a href="#orders" class="menu-item" onclick="showSection('orders')">
          <i class="bi bi-cart3"></i>
          <span>Pedidos</span>
        </a>
        <a
          href="#restaurants"
          class="menu-item"
          onclick="showSection('restaurants')"
        >
          <i class="bi bi-shop"></i>
          <span>Restaurantes</span>
        </a>
        <a
          href="#delivery-applications"
          class="menu-item"
          onclick="showSection('delivery-applications')"
        >
          <i class="bi bi-bicycle"></i>
          <span>Solicitudes Domiciliarios</span>
        </a>
        <a href="#reports" class="menu-item" onclick="showSection('reports')">
          <i class="bi bi-graph-up"></i>
          <span>Reportes</span>
        </a>
        <a href="#settings" class="menu-item" onclick="showSection('settings')">
          <i class="bi bi-gear"></i>
          <span>Configuración</span>
        </a>
      </div>

      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar">
            <i class="bi bi-person-circle"></i>
          </div>
          <div class="user-details">
            <p class="user-name" id="adminName">Admin</p>
            <p class="user-role">Administrador</p>
          </div>
        </div>
        <button class="btn-logout" onclick="logout()">
          <i class="bi bi-box-arrow-right"></i>
          Cerrar sesión
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Top Navigation -->
      <nav class="top-navbar">
        <div class="navbar-left">
          <button
            class="btn-toggle-sidebar d-lg-none"
            onclick="toggleSidebar()"
          >
            <i class="bi bi-list"></i>
          </button>
          <h2 class="page-title" id="pageTitle">Dashboard</h2>
        </div>

        <div class="navbar-right">
          <div class="search-box">
            <i class="bi bi-search"></i>
            <input type="text" placeholder="Buscar..." />
          </div>

          <div class="notifications">
            <button class="btn-notification">
              <i class="bi bi-bell"></i>
              <span class="notification-badge">3</span>
            </button>
          </div>

          <div class="admin-profile">
            <img
              src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z'/%3E%3C/svg%3E"
              alt="Admin"
              class="profile-img"
            />
          </div>
        </div>
      </nav>

      <!-- Dashboard Content -->
      <div class="content-area">
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="content-section active">
          <div class="dashboard-grid">
            <!-- Stats Cards -->
            <div class="stats-row">
              <div class="stat-card">
                <div class="stat-icon bg-primary">
                  <i class="bi bi-people"></i>
                </div>
                <div class="stat-content">
                  <h3 id="totalUsers">1,234</h3>
                  <p>Total Usuarios</p>
                  <span class="stat-trend positive">
                    <i class="bi bi-arrow-up"></i> +12% este mes
                  </span>
                </div>
              </div>

              <div class="stat-card">
                <div class="stat-icon bg-success">
                  <i class="bi bi-cart-check"></i>
                </div>
                <div class="stat-content">
                  <h3 id="totalOrders">5,678</h3>
                  <p>Pedidos Totales</p>
                  <span class="stat-trend positive">
                    <i class="bi bi-arrow-up"></i> +8% esta semana
                  </span>
                </div>
              </div>

              <div class="stat-card">
                <div class="stat-icon bg-warning">
                  <i class="bi bi-shop"></i>
                </div>
                <div class="stat-content">
                  <h3 id="totalRestaurants">89</h3>
                  <p>Restaurantes</p>
                  <span class="stat-trend positive">
                    <i class="bi bi-arrow-up"></i> +3 nuevos
                  </span>
                </div>
              </div>

              <div class="stat-card">
                <div class="stat-icon bg-info">
                  <i class="bi bi-currency-dollar"></i>
                </div>
                <div class="stat-content">
                  <h3 id="totalRevenue">$45,890</h3>
                  <p>Ingresos del Mes</p>
                  <span class="stat-trend positive">
                    <i class="bi bi-arrow-up"></i> +15% vs mes anterior
                  </span>
                </div>
              </div>
            </div>

            <!-- Charts Row -->
            <div class="charts-row">
              <div class="chart-card">
                <div class="card-header">
                  <h5>Pedidos por Día</h5>
                  <div class="card-actions">
                    <button class="btn btn-sm btn-outline-primary">
                      Ver más
                    </button>
                  </div>
                </div>
                <div class="chart-container">
                  <canvas id="ordersChart"></canvas>
                </div>
              </div>

              <div class="chart-card">
                <div class="card-header">
                  <h5>Restaurantes Populares</h5>
                  <div class="card-actions">
                    <button class="btn btn-sm btn-outline-primary">
                      Ver todos
                    </button>
                  </div>
                </div>
                <div class="popular-restaurants">
                  <div class="restaurant-item">
                    <div class="restaurant-info">
                      <img
                        src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' fill='%23ff6b35' viewBox='0 0 16 16'%3E%3Cpath d='M8.5 5a.5.5 0 0 0-1 0v1.5H6a.5.5 0 0 0 0 1h1.5V9a.5.5 0 0 0 1 0V7.5H10a.5.5 0 0 0 0-1H8.5V5z'/%3E%3Cpath d='M2 2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H2zm0 1h12a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1z'/%3E%3C/svg%3E"
                        alt="Restaurant"
                        class="restaurant-logo"
                      />
                      <div class="restaurant-details">
                        <h6>Pizza Palace</h6>
                        <p>234 pedidos hoy</p>
                      </div>
                    </div>
                    <div class="restaurant-stats">
                      <span class="badge bg-success">4.8★</span>
                      <span class="revenue">$2,340</span>
                    </div>
                  </div>

                  <div class="restaurant-item">
                    <div class="restaurant-info">
                      <img
                        src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' fill='%2328a745' viewBox='0 0 16 16'%3E%3Cpath d='M8.5 5a.5.5 0 0 0-1 0v1.5H6a.5.5 0 0 0 0 1h1.5V9a.5.5 0 0 0 1 0V7.5H10a.5.5 0 0 0 0-1H8.5V5z'/%3E%3Cpath d='M2 2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H2zm0 1h12a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1z'/%3E%3C/svg%3E"
                        alt="Restaurant"
                        class="restaurant-logo"
                      />
                      <div class="restaurant-details">
                        <h6>Burger House</h6>
                        <p>189 pedidos hoy</p>
                      </div>
                    </div>
                    <div class="restaurant-stats">
                      <span class="badge bg-success">4.6★</span>
                      <span class="revenue">$1,890</span>
                    </div>
                  </div>

                  <div class="restaurant-item">
                    <div class="restaurant-info">
                      <img
                        src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' fill='%23dc3545' viewBox='0 0 16 16'%3E%3Cpath d='M8.5 5a.5.5 0 0 0-1 0v1.5H6a.5.5 0 0 0 0 1h1.5V9a.5.5 0 0 0 1 0V7.5H10a.5.5 0 0 0 0-1H8.5V5z'/%3E%3Cpath d='M2 2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H2zm0 1h12a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1z'/%3E%3C/svg%3E"
                        alt="Restaurant"
                        class="restaurant-logo"
                      />
                      <div class="restaurant-details">
                        <h6>Sushi Zen</h6>
                        <p>156 pedidos hoy</p>
                      </div>
                    </div>
                    <div class="restaurant-stats">
                      <span class="badge bg-success">4.9★</span>
                      <span class="revenue">$1,560</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Recent Activity -->
            <div class="activity-row">
              <div class="activity-card">
                <div class="card-header">
                  <h5>Actividad Reciente</h5>
                  <div class="card-actions">
                    <button class="btn btn-sm btn-outline-primary">
                      Ver todo
                    </button>
                  </div>
                </div>
                <div class="activity-list">
                  <div class="activity-item">
                    <div class="activity-icon bg-success">
                      <i class="bi bi-person-plus"></i>
                    </div>
                    <div class="activity-content">
                      <p>
                        <strong>Nuevo usuario registrado:</strong> María
                        González
                      </p>
                      <span class="activity-time">Hace 5 minutos</span>
                    </div>
                  </div>

                  <div class="activity-item">
                    <div class="activity-icon bg-primary">
                      <i class="bi bi-cart-plus"></i>
                    </div>
                    <div class="activity-content">
                      <p>
                        <strong>Nuevo pedido:</strong> #12345 - Pizza Margherita
                      </p>
                      <span class="activity-time">Hace 12 minutos</span>
                    </div>
                  </div>

                  <div class="activity-item">
                    <div class="activity-icon bg-warning">
                      <i class="bi bi-shop"></i>
                    </div>
                    <div class="activity-content">
                      <p>
                        <strong>Nuevo restaurante:</strong> Comida Italiana
                        Marco
                      </p>
                      <span class="activity-time">Hace 1 hora</span>
                    </div>
                  </div>

                  <div class="activity-item">
                    <div class="activity-icon bg-info">
                      <i class="bi bi-star"></i>
                    </div>
                    <div class="activity-content">
                      <p><strong>Nueva reseña:</strong> 5★ para Burger House</p>
                      <span class="activity-time">Hace 2 horas</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Users Section -->
        <div id="users-section" class="content-section">
          <div class="section-header">
            <h3>Gestión de Usuarios</h3>
            <button class="btn btn-primary">
              <i class="bi bi-person-plus"></i> Agregar Usuario
            </button>
          </div>
          <div class="table-card">
            <p>Contenido de usuarios - En desarrollo</p>
          </div>
        </div>

        <!-- Orders Section -->
        <div id="orders-section" class="content-section">
          <div class="section-header">
            <h3>Gestión de Pedidos</h3>
            <button class="btn btn-primary">
              <i class="bi bi-plus-circle"></i> Nuevo Pedido
            </button>
          </div>
          <div class="table-card">
            <p>Contenido de pedidos - En desarrollo</p>
          </div>
        </div>

        <!-- Restaurants Section -->
        <div id="restaurants-section" class="content-section">
          <div class="section-header">
            <h3>Gestión de Restaurantes</h3>
            <button class="btn btn-primary">
              <i class="bi bi-shop"></i> Agregar Restaurante
            </button>
          </div>
          <div class="table-card">
            <p>Contenido de restaurantes - En desarrollo</p>
          </div>
        </div>

        <!-- Delivery Applications Section -->
        <div id="delivery-applications-section" class="content-section">
          <div class="section-header">
            <h3>Solicitudes de Domiciliarios</h3>
            <div class="header-actions">
              <button
                class="btn btn-outline-secondary"
                onclick="loadDeliveryApplications('all')"
              >
                <i class="bi bi-list"></i> Todas
              </button>
              <button
                class="btn btn-warning"
                onclick="loadDeliveryApplications('pendiente')"
              >
                <i class="bi bi-clock"></i> Pendientes
              </button>
              <button
                class="btn btn-success"
                onclick="loadDeliveryApplications('aprobada')"
              >
                <i class="bi bi-check"></i> Aprobadas
              </button>
              <button
                class="btn btn-danger"
                onclick="loadDeliveryApplications('rechazada')"
              >
                <i class="bi bi-x"></i> Rechazadas
              </button>
            </div>
          </div>

          <!-- Statistics Cards -->
          <div class="stats-row mb-4">
            <div class="stat-card">
              <div class="stat-icon bg-warning">
                <i class="bi bi-clock-history"></i>
              </div>
              <div class="stat-content">
                <h3 id="pendingApplications">0</h3>
                <p>Pendientes</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon bg-success">
                <i class="bi bi-check-circle"></i>
              </div>
              <div class="stat-content">
                <h3 id="approvedApplications">0</h3>
                <p>Aprobadas</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon bg-danger">
                <i class="bi bi-x-circle"></i>
              </div>
              <div class="stat-content">
                <h3 id="rejectedApplications">0</h3>
                <p>Rechazadas</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon bg-info">
                <i class="bi bi-people"></i>
              </div>
              <div class="stat-content">
                <h3 id="totalApplications">0</h3>
                <p>Total</p>
              </div>
            </div>
          </div>

          <!-- Applications Table -->
          <div class="table-card">
            <div class="table-header">
              <h5>Lista de Solicitudes</h5>
              <div class="table-actions">
                <input
                  type="text"
                  placeholder="Buscar por nombre o email..."
                  class="form-control search-input"
                  id="searchApplications"
                />
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Usuario</th>
                    <th>Contacto</th>
                    <th>Fecha Solicitud</th>
                    <th>Estado</th>
                    <th>Fecha Revisión</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="applicationsTableBody">
                  <!-- Las solicitudes se cargarán aquí dinámicamente -->
                </tbody>
              </table>
            </div>
            <div id="applicationsLoading" class="text-center p-4 d-none">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
            </div>
            <div id="noApplicationsMessage" class="text-center p-4 d-none">
              <i
                class="bi bi-inbox"
                style="font-size: 3rem; color: #6c757d"
              ></i>
              <p class="text-muted mt-2">No hay solicitudes que mostrar</p>
            </div>
          </div>
        </div>

        <!-- Reports Section -->
        <div id="reports-section" class="content-section">
          <div class="section-header">
            <h3>Reportes y Análisis</h3>
            <button class="btn btn-primary">
              <i class="bi bi-download"></i> Exportar
            </button>
          </div>
          <div class="table-card">
            <p>Contenido de reportes - En desarrollo</p>
          </div>
        </div>

        <!-- Settings Section -->
        <div id="settings-section" class="content-section">
          <div class="section-header">
            <h3>Configuración del Sistema</h3>
            <button class="btn btn-primary">
              <i class="bi bi-gear"></i> Guardar Cambios
            </button>
          </div>
          <div class="table-card">
            <p>Contenido de configuración - En desarrollo</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para Revisar Solicitud -->
    <div
      class="modal fade"
      id="reviewApplicationModal"
      tabindex="-1"
      aria-labelledby="reviewApplicationModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="reviewApplicationModalLabel">
              Revisar Solicitud de Domiciliario
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="applicationDetails">
              <!-- Los detalles se cargarán aquí -->
            </div>

            <form id="reviewForm">
              <input type="hidden" id="applicationId" />

              <div class="mb-3">
                <label for="applicationStatus" class="form-label"
                  >Decisión *</label
                >
                <select class="form-select" id="applicationStatus" required>
                  <option value="">Seleccionar decisión...</option>
                  <option value="aprobada">✅ Aprobar Solicitud</option>
                  <option value="rechazada">❌ Rechazar Solicitud</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="applicationObservations" class="form-label"
                  >Observaciones (Opcional)</label
                >
                <textarea
                  class="form-control"
                  id="applicationObservations"
                  rows="3"
                  placeholder="Ingresa cualquier comentario o razón para tu decisión..."
                ></textarea>
                <div class="form-text">
                  Estas observaciones serán visibles para el usuario
                  solicitante.
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="submitReview()"
            >
              <i class="bi bi-check2"></i> Enviar Decisión
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      // Variables globales
      let sidebarOpen = true;

      // Función para alternar sidebar
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const mainContent = document.querySelector(".main-content");

        sidebar.classList.toggle("collapsed");
        mainContent.classList.toggle("expanded");
        sidebarOpen = !sidebarOpen;
      }

      // Función para mostrar secciones
      function showSection(sectionName) {
        // Ocultar todas las secciones
        const sections = document.querySelectorAll(".content-section");
        sections.forEach((section) => {
          section.classList.remove("active");
        });

        // Mostrar la sección seleccionada
        document
          .getElementById(sectionName + "-section")
          .classList.add("active");

        // Actualizar el título de la página
        const titles = {
          dashboard: "Dashboard",
          users: "Gestión de Usuarios",
          orders: "Gestión de Pedidos",
          restaurants: "Gestión de Restaurantes",
          "delivery-applications": "Solicitudes de Domiciliarios",
          reports: "Reportes y Análisis",
          settings: "Configuración del Sistema",
        };
        document.getElementById("pageTitle").textContent = titles[sectionName];

        // Actualizar menu activo
        const menuItems = document.querySelectorAll(".menu-item");
        menuItems.forEach((item) => {
          item.classList.remove("active");
        });
        event.target.closest(".menu-item").classList.add("active");
      }

      // Función de logout
      function logout() {
        console.log("Logout function called");
        try {
          if (confirm("¿Estás seguro de que deseas cerrar sesión?")) {
            console.log("User confirmed logout");
            localStorage.removeItem("token");
            localStorage.removeItem("user");
            console.log("Tokens removed, redirecting...");
            window.location.href = "/login";
          } else {
            console.log("User cancelled logout");
          }
        } catch (error) {
          console.error("Error in logout function:", error);
          alert("Error al cerrar sesión: " + error.message);
        }
      }

      // Verificar autenticación al cargar la página
      document.addEventListener("DOMContentLoaded", function () {
        const token = localStorage.getItem("token");
        const user = JSON.parse(localStorage.getItem("user") || "{}");

        if (!token) {
          window.location.href = "/login";
          return;
        }

        // Verificar si es admin
        if (user.role !== "admin") {
          alert("Acceso denegado. Solo administradores pueden acceder.");
          window.location.href = "/";
          return;
        }

        // Mostrar nombre del admin
        if (user.username) {
          document.getElementById("adminName").textContent = user.username;
        }

        // Cargar datos del dashboard
        loadDashboardData();

        // Inicializar gráfico
        initChart();

        // Event listener para el botón de logout como respaldo
        const logoutBtn = document.querySelector(".btn-logout");
        if (logoutBtn) {
          console.log("Logout button found, adding event listener");
          logoutBtn.addEventListener("click", function (e) {
            console.log("Logout button clicked via event listener");
            e.preventDefault();
            logout();
          });
        } else {
          console.error("Logout button not found!");
        }
      });

      // Función para cargar datos del dashboard
      async function loadDashboardData() {
        try {
          const token = localStorage.getItem("token");
          const response = await fetch("/api/v1/admin/dashboard/stats", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.ok) {
            const result = await response.json();
            if (result.ok) {
              updateDashboardStats(result.stats);
            }
          } else if (response.status === 403) {
            alert("Acceso denegado");
            logout();
          }
        } catch (error) {
          console.error("Error loading dashboard data:", error);
        }
      }

      // Función para actualizar las estadísticas
      function updateDashboardStats(stats) {
        document.getElementById("totalUsers").textContent =
          stats.totalUsers.toLocaleString();
        document.getElementById("totalOrders").textContent =
          stats.totalOrders.toLocaleString();
        document.getElementById("totalRestaurants").textContent =
          stats.totalRestaurants;
        document.getElementById(
          "totalRevenue"
        ).textContent = `$${stats.totalRevenue.toLocaleString()}`;
      }

      // Función para inicializar el gráfico
      function initChart() {
        const ctx = document.getElementById("ordersChart").getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: {
            labels: ["Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"],
            datasets: [
              {
                label: "Pedidos",
                data: [65, 59, 80, 81, 56, 95, 40],
                borderColor: "#e74c3c",
                backgroundColor: "rgba(231, 76, 60, 0.1)",
                borderWidth: 3,
                fill: true,
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: "rgba(0,0,0,0.1)",
                },
              },
              x: {
                grid: {
                  color: "rgba(0,0,0,0.1)",
                },
              },
            },
            plugins: {
              legend: {
                display: false,
              },
            },
          },
        });
      }

      // Responsive: cerrar sidebar en móviles al hacer clic en menu
      if (window.innerWidth <= 992) {
        sidebarOpen = false;
        document.getElementById("sidebar").classList.add("collapsed");
        document.querySelector(".main-content").classList.add("expanded");
      }

      // === FUNCIONES PARA SOLICITUDES DE DOMICILIARIOS ===

      // Cargar solicitudes de domiciliarios
      async function loadDeliveryApplications(status = "all") {
        try {
          showApplicationsLoading(true);

          const token = localStorage.getItem("token");
          const url =
            status === "all"
              ? "/api/v1/delivery-applications/all"
              : `/api/v1/delivery-applications/all?status=${status}`;

          const response = await fetch(url, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          const data = await response.json();

          if (data.success) {
            displayApplications(data.data);
            loadApplicationsStats(); // Cargar estadísticas
          } else {
            console.error("Error cargando solicitudes:", data.message);
            showNoApplicationsMessage(true);
          }
        } catch (error) {
          console.error("Error:", error);
          showNoApplicationsMessage(true);
        } finally {
          showApplicationsLoading(false);
        }
      }

      // Mostrar/ocultar loading
      function showApplicationsLoading(show) {
        const loading = document.getElementById("applicationsLoading");
        const table = document.querySelector(
          "#delivery-applications-section .table-responsive"
        );

        if (show) {
          loading.classList.remove("d-none");
          table.style.opacity = "0.5";
        } else {
          loading.classList.add("d-none");
          table.style.opacity = "1";
        }
      }

      // Mostrar mensaje de no solicitudes
      function showNoApplicationsMessage(show) {
        const message = document.getElementById("noApplicationsMessage");
        const table = document.querySelector(
          "#delivery-applications-section .table-responsive"
        );

        if (show) {
          message.classList.remove("d-none");
          table.classList.add("d-none");
        } else {
          message.classList.add("d-none");
          table.classList.remove("d-none");
        }
      }

      // Mostrar solicitudes en la tabla
      function displayApplications(applications) {
        const tbody = document.getElementById("applicationsTableBody");

        if (applications.length === 0) {
          showNoApplicationsMessage(true);
          return;
        }

        showNoApplicationsMessage(false);

        tbody.innerHTML = applications
          .map(
            (app) => `
          <tr>
            <td>
              <div class="user-info">
                <strong>${app.nombre}</strong>
                <small class="text-muted d-block">ID: ${app.user_id}</small>
              </div>
            </td>
            <td>
              <div>
                <i class="bi bi-envelope"></i> ${app.email}
                ${
                  app.telefono
                    ? `<br><i class="bi bi-telephone"></i> ${app.telefono}`
                    : ""
                }
              </div>
            </td>
            <td>
              <small>${formatDate(app.fecha_solicitud)}</small>
            </td>
            <td>
              <span class="badge ${getStatusBadgeClass(app.status)}">
                ${getStatusText(app.status)}
              </span>
            </td>
            <td>
              ${
                app.fecha_revision
                  ? `<small>${formatDate(app.fecha_revision)}</small>`
                  : '<span class="text-muted">-</span>'
              }
              ${
                app.admin_nombre
                  ? `<br><small class="text-muted">Por: ${app.admin_nombre}</small>`
                  : ""
              }
            </td>
            <td>
              <div class="action-buttons">
                <button 
                  class="btn btn-sm btn-outline-primary" 
                  onclick="reviewApplication(${app.id})"
                  title="Revisar solicitud"
                >
                  <i class="bi bi-eye"></i>
                </button>
                ${
                  app.status === "pendiente"
                    ? `
                  <button 
                    class="btn btn-sm btn-success" 
                    onclick="quickApprove(${app.id})"
                    title="Aprobar rápidamente"
                  >
                    <i class="bi bi-check"></i>
                  </button>
                  <button 
                    class="btn btn-sm btn-danger" 
                    onclick="quickReject(${app.id})"
                    title="Rechazar rápidamente"
                  >
                    <i class="bi bi-x"></i>
                  </button>
                `
                    : ""
                }
              </div>
            </td>
          </tr>
        `
          )
          .join("");
      }

      // Obtener clase CSS para el badge de estado
      function getStatusBadgeClass(status) {
        const classes = {
          pendiente: "bg-warning",
          aprobada: "bg-success",
          rechazada: "bg-danger",
        };
        return classes[status] || "bg-secondary";
      }

      // Obtener texto del estado
      function getStatusText(status) {
        const texts = {
          pendiente: "Pendiente",
          aprobada: "Aprobada",
          rechazada: "Rechazada",
        };
        return texts[status] || status;
      }

      // Cargar estadísticas de solicitudes
      async function loadApplicationsStats() {
        try {
          const token = localStorage.getItem("token");
          const response = await fetch("/api/v1/delivery-applications/stats", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          const data = await response.json();

          if (data.success) {
            const stats = data.data;
            document.getElementById("pendingApplications").textContent =
              stats.pendientes || 0;
            document.getElementById("approvedApplications").textContent =
              stats.aprobadas || 0;
            document.getElementById("rejectedApplications").textContent =
              stats.rechazadas || 0;
            document.getElementById("totalApplications").textContent =
              stats.total || 0;
          }
        } catch (error) {
          console.error("Error cargando estadísticas:", error);
        }
      }

      // Revisar solicitud (abrir modal)
      async function reviewApplication(applicationId) {
        try {
          const token = localStorage.getItem("token");
          const response = await fetch(
            `/api/v1/delivery-applications/${applicationId}`,
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          const data = await response.json();

          if (data.success) {
            const app = data.data;

            // Llenar detalles en el modal
            document.getElementById("applicationId").value = app.id;
            document.getElementById("applicationDetails").innerHTML = `
              <div class="row">
                <div class="col-md-6">
                  <h6>Información del Usuario</h6>
                  <p><strong>Nombre:</strong> ${app.nombre}</p>
                  <p><strong>Email:</strong> ${app.email}</p>
                  <p><strong>Teléfono:</strong> ${
                    app.telefono || "No proporcionado"
                  }</p>
                </div>
                <div class="col-md-6">
                  <h6>Detalles de la Solicitud</h6>
                  <p><strong>Fecha:</strong> ${formatDate(
                    app.fecha_solicitud
                  )}</p>
                  <p><strong>Estado Actual:</strong> 
                    <span class="badge ${getStatusBadgeClass(app.status)}">
                      ${getStatusText(app.status)}
                    </span>
                  </p>
                  ${
                    app.observaciones
                      ? `<p><strong>Observaciones:</strong> ${app.observaciones}</p>`
                      : ""
                  }
                </div>
              </div>
            `;

            // Mostrar el modal
            const modal = new bootstrap.Modal(
              document.getElementById("reviewApplicationModal")
            );
            modal.show();
          }
        } catch (error) {
          console.error("Error cargando detalles:", error);
          alert("Error cargando los detalles de la solicitud");
        }
      }

      // Enviar revisión
      async function submitReview() {
        try {
          const applicationId = document.getElementById("applicationId").value;
          const status = document.getElementById("applicationStatus").value;
          const observaciones = document.getElementById(
            "applicationObservations"
          ).value;

          if (!status) {
            alert("Por favor selecciona una decisión");
            return;
          }

          const token = localStorage.getItem("token");
          const response = await fetch(
            `/api/v1/delivery-applications/${applicationId}/status`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                status: status,
                observaciones: observaciones,
              }),
            }
          );

          const data = await response.json();

          if (data.success) {
            alert(`Solicitud ${status} exitosamente`);

            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("reviewApplicationModal")
            );
            modal.hide();

            // Recargar solicitudes
            loadDeliveryApplications();

            // Limpiar formulario
            document.getElementById("reviewForm").reset();
          } else {
            alert("Error: " + data.message);
          }
        } catch (error) {
          console.error("Error enviando revisión:", error);
          alert("Error de conexión");
        }
      }

      // Aprobación rápida
      async function quickApprove(applicationId) {
        if (confirm("¿Estás seguro de que quieres aprobar esta solicitud?")) {
          await updateApplicationStatus(
            applicationId,
            "aprobada",
            "Aprobación rápida"
          );
        }
      }

      // Rechazo rápido
      async function quickReject(applicationId) {
        const reason = prompt("Razón del rechazo (opcional):");
        if (reason !== null) {
          await updateApplicationStatus(
            applicationId,
            "rechazada",
            reason || "Rechazado"
          );
        }
      }

      // Actualizar estado de solicitud
      async function updateApplicationStatus(
        applicationId,
        status,
        observaciones
      ) {
        try {
          const token = localStorage.getItem("token");
          const response = await fetch(
            `/api/v1/delivery-applications/${applicationId}/status`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                status: status,
                observaciones: observaciones,
              }),
            }
          );

          const data = await response.json();

          if (data.success) {
            alert(`Solicitud ${status} exitosamente`);
            loadDeliveryApplications();
          } else {
            alert("Error: " + data.message);
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error de conexión");
        }
      }

      // Formatear fecha
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("es-ES", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      // Event listeners para delivery applications
      document.addEventListener("DOMContentLoaded", function () {
        // Cargar solicitudes cuando se muestre la sección
        const deliverySection = document.getElementById(
          "delivery-applications-section"
        );
        if (deliverySection) {
          // Observer para detectar cuando se muestra la sección
          const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
              if (
                mutation.type === "attributes" &&
                mutation.attributeName === "class"
              ) {
                if (deliverySection.classList.contains("active")) {
                  loadDeliveryApplications();
                }
              }
            });
          });

          observer.observe(deliverySection, { attributes: true });
        }

        // Búsqueda en tiempo real
        const searchInput = document.getElementById("searchApplications");
        if (searchInput) {
          searchInput.addEventListener("input", function (e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll("#applicationsTableBody tr");

            rows.forEach((row) => {
              const text = row.textContent.toLowerCase();
              if (text.includes(searchTerm)) {
                row.style.display = "";
              } else {
                row.style.display = "none";
              }
            });
          });
        }
      });
    </script>
  </body>
</html>
